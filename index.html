<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рккрк░ркорк╛рк░ рклрлЗркорк┐рк▓рлА рклрк╛ркЗркирк╛ркирлНрк╕ рккрлНрк░рлЛ</title>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.9); --primary: #4338ca; }
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite; min-height: 100vh;
        }
        @keyframes gradientBG { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }
        .wrapper { max-width: 1250px; margin: auto; }
        .header { text-align: center; padding: 20px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 20px; color: white; margin-bottom: 20px; }
        .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .balance-card { background: var(--glass); border-radius: 20px; padding: 20px; border-left: 8px solid var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .bal-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ccc; }
        .card { background: var(--glass); border-radius: 20px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-save { background: #4338ca; color: white; }
        .btn-trf { background: #7c3aed; color: white; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; color: white; z-index: 1000; flex-direction: column; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .update-footer { text-align: center; color: white; margin-top: 20px; font-size: 0.9rem; opacity: 0.8; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .bg-inc { background: #dcfce7; color: #166534; }
        .bg-exp { background: #fee2e2; color: #991b1b; }
        .bg-trf { background: #f3e8ff; color: #5b21b6; }
        .offline-tag { background: #f59e0b; color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div style="font-size: 2rem;">тМЫ</div>
    <div id="loaderText">рккрлНрк░рлЛрк╕рлЗрк╕ ркеркИ рк░рк╣рлА ркЫрлЗ...</div>
</div>

<div class="wrapper">
    <div class="header">
        <h1>ЁЯТО рккрк░ркорк╛рк░ рклрлЗркорк┐рк▓рлА рклрк╛ркЗркирк╛ркирлНрк╕ рккрлНрк░рлЛ</h1>
        <button onclick="fetchDataFromSheet()" style="background:white; color:black; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; margin-top:10px;">ЁЯФД ркбрлЗркЯрк╛ рк░рк┐рклрлНрк░рлЗрк╢ ркХрк░рлЛ</button>
    </div>

    <div id="balanceDisplay" class="balance-grid"></div>

    <div class="main-grid">
        <div class="card">
            <h3>ЁЯУЭ ркирк╡рлА ркПркирлНркЯрлНрк░рлА</h3>
            <label>рк╕ркнрлНркп</label>
            <select id="e_user"></select>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>рккрлНрк░ркХрк╛рк░</label><select id="e_type" onchange="updateCatOptions()"><option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option><option value="expense">ркЦрк░рлНркЪ</option><option value="income">ркЖрк╡ркХ</option></select></div>
                <div style="flex:1"><label>ркорлЛркб</label><select id="e_mode"><option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option><option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Card">Card</option></select></div>
            </div>
            <label>рк░ркХрко (тВ╣)</label><input type="number" id="e_amt" placeholder="0.00">
            <label>ркХрлЗркЯрлЗркЧрк░рлА</label><select id="e_cat" onchange="showHideCustomCat()"><option value="">-- рккрлНрк░ркХрк╛рк░ рккрк╕ркВркж ркХрк░рлЛ --</option></select>
            <div id="customCatDiv" style="display:none;"><label>рк╡рк┐ркЧркд (ркЕркирлНркп)</label><input type="text" id="e_custom_cat"></div>
            <button class="btn btn-save" onclick="processEntry()">ЁЯТ╛ рк╕рлЗрк╡ ркХрк░рлЛ</button>
        </div>

        <div class="card">
            <h3>ЁЯФД ркЯрлНрк░рк╛ркирлНрк╕рклрк░</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>From</label><select id="t_u_from"></select></div>
                <div style="flex:1"><label>To</label><select id="t_u_to"></select></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>ркорлЛркб (From)</label><select id="t_m_from"><option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option><option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Card">Card</option></select></div>
                <div style="flex:1"><label>ркорлЛркб (To)</label><select id="t_m_to"><option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option><option value="Cash">Cash</option><option value="Bank">Bank</option><option value="Card">Card</option></select></div>
            </div>
            <label>рк░ркХрко (тВ╣)</label><input type="number" id="t_amt" placeholder="0.00">
            <button class="btn btn-trf" onclick="processTransfer()">ЁЯФД ркЯрлНрк░рк╛ркирлНрк╕рклрк░ ркХркирлНрклрк░рлНрко</button>
        </div>
    </div>

    <div class="card">
        <h3>ЁЯУЬ рк╣рк┐рк╕рлНркЯрлНрк░рлА</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>ркдрк╛рк░рлАркЦ</th><th>рк╕ркнрлНркп</th><th>рккрлНрк░ркХрк╛рк░</th><th>рк╡рк┐ркЧркд</th><th>ркорлЛркб</th><th>рк░ркХрко</th><th>ркПркХрлНрк╢рки</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="update-footer" id="lastUpdateText">ркдрккрк╛рк╕рлА рк░рк╣рлНркпрлБркВ ркЫрлЗ...</div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNXx_h-7PcY5_Fywly59vHV_iUa5QGFZU1K0rQcXOaNPpMZiyFdTBq5STRAdY4orqx/exec";
    const members = ["рк╣рк░рккрк╛рк▓", "рк╕рлЛркирк▓", "ркХрлНрк░рк┐рк╢рк╛", "ркорк╣рк┐рк░рк╛ркЬ"];
    const cats = { expense: ["ркХрк░рк┐ркпрк╛ркгрлБркВ", "ркжрлВркз", "рк╢рк╛ркХркнрк╛ркЬрлА", "ркмрк┐рк▓", "ркжрк╡рк╛", "рккрлЗркЯрлНрк░рлЛрк▓", "ркЕркирлНркп"], income: ["рккркЧрк╛рк░", "рк╡рлНркпрк╛ркЬ", "ркнрлЗркЯ", "ркЕркирлНркп"] };
    
    let transactions = [];
    let offlineQueue = JSON.parse(localStorage.getItem('parmar_offline')) || [];
    let openingBalances = {"рк╣рк░рккрк╛рк▓":{"Cash":0,"Bank":0,"Card":0},"рк╕рлЛркирк▓":{"Cash":0,"Bank":0,"Card":0},"ркХрлНрк░рк┐рк╢рк╛":{"Cash":0,"Bank":0,"Card":0},"ркорк╣рк┐рк░рк╛ркЬ":{"Cash":0,"Bank":0,"Card":0}};

    async function init() {
        ['e_user', 't_u_from', 't_u_to'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = `<option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option>`;
            members.forEach(m => { el.innerHTML += `<option value="${m}">${m}</option>`; });
        });
        await fetchDataFromSheet();
        checkSync();
    }

    async function fetchDataFromSheet() {
        if (!navigator.onLine) {
            renderAll();
            return;
        }
        showLoader(true, "ркбрлЗркЯрк╛ ркЦрлЗркВркЪрлА рк░рк╣рлНркпрлЛ ркЫрлЗ...");
        try {
            const response = await fetch(SCRIPT_URL + "?action=getInitialData");
            const data = await response.json();
            
            if(data.opening && data.opening.length > 1) {
                data.opening.slice(1).forEach(row => {
                    let u = row[0];
                    if(openingBalances[u]) {
                        openingBalances[u].Cash = parseFloat(row[1]) || 0;
                        openingBalances[u].Bank = parseFloat(row[2]) || 0;
                        openingBalances[u].Card = parseFloat(row[3]) || 0;
                    }
                });
            }
            if(data.logs) {
                transactions = data.logs.slice(1).map(row => ({
                    id: row[0], date: row[1], user: row[2], type: row[3],
                    mode: row[4], amt: parseFloat(row[5]), cat: row[6], isTransfer: String(row[7]) === "true"
                }));
            }
            document.getElementById('lastUpdateText').innerText = "ркЫрлЗрк▓рлНрк▓рлБркВ ркЕрккркбрлЗркЯ: " + new Date().toLocaleString();
            renderAll();
        } catch (e) { console.error(e); }
        showLoader(false);
    }

    function renderAll() {
        let stats = JSON.parse(JSON.stringify(openingBalances));
        let allData = [...transactions, ...offlineQueue];

        allData.forEach(t => {
            if (t.type === 'income' || t.type === 'transfer-in') stats[t.user][t.mode] += t.amt;
            else stats[t.user][t.mode] -= t.amt;
        });

        document.getElementById('balanceDisplay').innerHTML = members.map(m => `
            <div class="balance-card">
                <h4>ЁЯСд ${m}</h4>
                <div class="bal-row"><span>Cash</span> <b>тВ╣${stats[m].Cash}</b></div>
                <div class="bal-row"><span>Bank</span> <b>тВ╣${stats[m].Bank}</b></div>
                <div class="bal-row"><span>Card</span> <b>тВ╣${stats[m].Card}</b></div>
                <div style="margin-top:10px; font-weight:800; text-align:right; color:#4338ca;">Total: тВ╣${stats[m].Cash + stats[m].Bank + stats[m].Card}</div>
            </div>
        `).join('');

        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = "";
        let shownIds = new Set();
        [...allData].reverse().forEach(t => {
            if (t.isTransfer && shownIds.has(t.id)) return;
            if (t.isTransfer) shownIds.add(t.id);
            const badge = t.isTransfer ? 'bg-trf' : (t.type==='income'?'bg-inc':'bg-exp');
            const isOffline = offlineQueue.find(o => o.id === t.id);
            tbody.innerHTML += `
                <tr>
                    <td><small>${t.date}</small></td>
                    <td><b>${t.user}</b> ${isOffline ? '<span class="offline-tag">Offline</span>' : ''}</td>
                    <td><span class="badge ${badge}">${t.isTransfer ? 'TRANSFER' : t.type.toUpperCase()}</span></td>
                    <td>${t.cat}</td><td>${t.mode}</td>
                    <td style="font-weight:bold; color:${t.type.includes('income')||t.type.includes('in')?'#059669':'#dc2626'}">тВ╣${t.amt}</td>
                    <td>${!isOffline ? `<button onclick="deleteTransaction('${t.id}')" style="background:#ef4444; color:white; border:none; border-radius:4px; padding:5px; cursor:pointer;">ЁЯЧСя╕П</button>` : ''}</td>
                </tr>`;
        });
    }

    async function processEntry() {
        const user = document.getElementById('e_user').value;
        const type = document.getElementById('e_type').value;
        const mode = document.getElementById('e_mode').value;
        const amt = parseFloat(document.getElementById('e_amt').value);
        const catVal = document.getElementById('e_cat').value;

        if (!user || !type || !mode || isNaN(amt) || !catVal) return alert("ркмркзрлА рк╡рк┐ркЧркд ркнрк░рлЛ!");
        
        const entry = [{
            id: "E-" + Date.now(),
            date: new Date().toLocaleString('en-IN'),
            user, type, mode, amt, isTransfer: false,
            cat: (catVal === 'NEW') ? (document.getElementById('e_custom_cat').value || "ркЕркирлНркп") : catVal
        }];

        await sendToSheet(entry);
        resetForms();
    }

    async function processTransfer() {
        const uF = document.getElementById('t_u_from').value;
        const uT = document.getElementById('t_u_to').value;
        const mF = document.getElementById('t_m_from').value;
        const mT = document.getElementById('t_m_to').value;
        const amt = parseFloat(document.getElementById('t_amt').value);

        if (!uF || !uT || !mF || !mT || isNaN(amt)) return alert("рк╡рк┐ркЧркд ркЕркзрлВрк░рлА ркЫрлЗ!");
        const gid = "TRF-" + Date.now();
        const date = new Date().toLocaleString('en-IN');
        const entries = [
            { id: gid, date, user: uF, type: 'transfer-out', mode: mF, amt, cat: `тЮбя╕П To: ${uT}`, isTransfer: true },
            { id: gid, date, user: uT, type: 'transfer-in', mode: mT, amt, cat: `тмЕя╕П From: ${uF}`, isTransfer: true }
        ];
        await sendToSheet(entries);
        resetForms();
    }

    async function sendToSheet(payload) {
        if (!navigator.onLine) {
            offlineQueue.push(...payload);
            localStorage.setItem('parmar_offline', JSON.stringify(offlineQueue));
            renderAll();
            alert("ркЗркирлНркЯрк░ркирлЗркЯ ркиркерлА, ркПркирлНркЯрлНрк░рлА рклрлЛркиркорк╛ркВ рк╕рлЗрк╡ ркеркИ ркЫрлЗ!");
            return;
        }
        showLoader(true, "рк╢рлАркЯркорк╛ркВ рк╕рлЗрк╡ ркерк╛ркп ркЫрлЗ...");
        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "saveTransaction", payload: payload }) });
            await fetchDataFromSheet();
        } catch (e) { alert("ркнрлВрк▓ ркЖрк╡рлА!"); }
        showLoader(false);
    }

    async function checkSync() {
        if (navigator.onLine && offlineQueue.length > 0) {
            showLoader(true, "ркУрклрк▓рк╛ркЗрки ркПркирлНркЯрлНрк░рлА рк╕рк┐ркВркХ ркеркИ рк░рк╣рлА ркЫрлЗ...");
            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "saveTransaction", payload: offlineQueue }) });
                offlineQueue = [];
                localStorage.removeItem('parmar_offline');
                await fetchDataFromSheet();
            } catch (e) { console.log("Sync failed"); }
            showLoader(false);
        }
    }

    async function deleteTransaction(id) {
        if(!confirm("ркбрлАрк▓рлАркЯ ркХрк░рк╡рлБркВ ркЫрлЗ?")) return;
        showLoader(true);
        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "deleteTransaction", id: id }) });
            await fetchDataFromSheet();
        } catch (e) { alert("Error deleting"); }
        showLoader(false);
    }

    window.addEventListener('online', checkSync);
    function updateCatOptions() {
        const type = document.getElementById('e_type').value;
        const el = document.getElementById('e_cat');
        if(!type) { el.innerHTML = `<option value="">-- рккрлНрк░ркХрк╛рк░ рккрк╕ркВркж ркХрк░рлЛ --</option>`; return; }
        el.innerHTML = `<option value="">-- рккрк╕ркВркж ркХрк░рлЛ --</option>` + cats[type].map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="NEW">тЮХ ркирк╡рлА рк╡рк┐ркЧркд</option>`;
    }
    function showHideCustomCat() { document.getElementById('customCatDiv').style.display = (document.getElementById('e_cat').value === 'NEW') ? 'block' : 'none'; }
    function resetForms() { ['e_user','e_type','e_mode','e_cat','t_u_from','t_u_to','t_m_from','t_m_to','e_amt','t_amt'].forEach(id => { try{document.getElementById(id).value = "";}catch(e){} }); updateCatOptions(); }
    function showLoader(show, text="рк░рк╛рк╣ ркЬрлБркУ...") { document.getElementById('loader').style.display = show ? 'flex' : 'none'; document.getElementById('loaderText').innerText = text; }
    init();
</script>
</body>
</html>